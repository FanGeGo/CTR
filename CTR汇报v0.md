# CTR

**环境**：TensorFlow1.8，Python3.6

**文件大小**：train.csv文件5.88 G，test.csv文件673.1 MB

**问题类型**：分类

## 1 特征工程

**数据类型**

* 数据文件包含24列；
  * label：click
    * 表示该次广告投放是(1)否(0)被点击
  * 特征：23维，均为分类型



## 1.1 数据探索

**以下为训练集中特征值及计数**

#### **click**

> ```
> ------------click-------------
> 0    33563901
> 1     6865066
> Name: click, dtype: int64
> ```

由此可见 click 的数量不均衡，需要对样本进行均衡处理，考虑对样本进行多次下采样（不放回采样），最后将几个样本集训练得出的分类器进行组合；

```python
train_data.click.mean()
0.16980562476404604
```

训练集中点击率约为16.98%，该值可作为点击率的一个参考；



#### hour

> ```
> -------------hour-------------
> 14102209    447783
> 14102210    438270
> 14102813    432308
> 14102212    408650
> 14102814    387453
> 14102211    386757
> 14103004    347806
> 14102809    328576
> 14102213    323480
> 14102208    322803
> 14102808    291763
> ......
> Name: hour, Length: 240, dtype: int64
> ```

hour特征为日期型数据，格式为"YYMMDDHH"。

考虑从该特征分离处具体的“日期”，“几时”；

* 根据“日期”衍生类别型变量“日”、“是否工作日”以及“星期几”；

* ”几时“，转换成0~23类别特征；



#### C1

> ```
> --------------C1--------------
> 1005    37140632
> 1002     2220812
> 1010      903457
> 1012      113512
> 1007       35304
> 1001        9463
> 1008        5787
> Name: C1, dtype: int64
> 
> -------------------------C1-------------------------
>       display_sum  click_rate
> C1                           
> 1001         9463    0.033393
> 1002      2220812    0.210731
> 1005     37140632    0.169331
> 1007        35304    0.039429
> 1008         5787    0.121652
> 1010       903457    0.095215
> 1012       113512    0.172493
> ```

C1为类别型特征，暂时无法猜测物理含义。其中各特征值的点击率差异较大，对标签有较大影响，应该是不错的特征。



#### banner_pos

> ```
> ----------banner_pos----------
> 0    29109590
> 1    11247282
> 7       43577
> 2       13001
> 4        7704
> 5        5778
> 3        2035
> Name: banner_pos, dtype: int64
> ```

该特征应为广告海报的显示位置，如“上”，“下”，“左”，“右”等，作为分类型特征，应该是个不错的特征；



#### site_id

> ```
> -----------site_id------------
> 85f751fd    14596137
> 1fbe01fe     6486150
> e151e245     2637747
> d9750ee7      963745
> 5b08c53b      913325
> 5b4d2eda      771360
> 856e6d3f      765891
> a7853007      461311
> b7e9786d      369099
> ......
> 1c31ac16           1
> 2aa30f4e           1
> Name: site_id, Length: 4737, dtype: int64
> ```

网址id，可能是广告投放的网址，直接作为分类型特征处理；



#### site_domain

> ```
> ---------site_domain----------
> c4e18dd6    15131739
> f3845767     6486150
> 7e091613     3325008
> 7687a86e     1290165
> 98572c79      996816
> 16a36ef3      855686
> 58a89a43      765891
> 9d54950b      375891
> ......
> 9bf9b346           1
> c266215a           1
> Name: site_domain, Length: 7745, dtype: int64
> ```

网址所属领域，对用户起到分群作用，直接作为分类型特征处理；



#### site_category

> ```
> --------site_category---------
> 50e219e0    16537234
> f028772b    12657073
> 28905ebd     7377208
> 3e814130     3050306
> f66779e6      252451
> 75fa27f6      160985
> 335d28a8      136463
> 76b2941d      104754
> c0dd3be3       42090
> ......
> 6432c423           2
> a72a0145           2
> Name: site_category, dtype: int64
> ```

网址类别，与site_domain属于不同的分类方法，直接作为分类型特征处理；



#### app_id

> ```
> ------------app_id------------
> ecad2386    25832830
> 92f5800b     1555283
> e2fcccd2     1129016
> febd1138      759098
> 9c13b419      757812
> 7358e05e      615635
> ......
> 6746fb41           1
> 7b2b2217           1
> Name: app_id, Length: 8552, dtype: int64
> ```

此列中特征值“ecad2386”的计数远大于其他值，可能为web识别标签，考虑据此构建新特征“app_or_web";



#### app_domain

> ```
> ----------app_domain----------
> 7801e8d9    27237087
> 2347f47a     5240885
> ae637522     1881838
> 5c5a694b     1129228
> 82e27996      759125
> d9b5648e      713924
> ......
> 7366e108           1
> d1600859           1
> Name: app_domain, Length: 559, dtype: int64
> ```

处理方式同site_domain；



#### app_category

> ```
> ---------app_category---------
> 07d7df22    26165592
> 0f2161f8     9561058
> cef3e649     1731545
> 8ded1f7a     1467257
> f95efa07     1141673
> ......
> cba0e20d           1
> 52de74cf           1
> Name: app_category, dtype: int64
> ```

处理方式同site_domain；



#### device_id

> ```
> ----------device_id-----------
> a99f214a    33358308
> 0f7c61dc       21356
> c357dbff       19667
> 936e92fb       13712
> afeffc18        9654
> 987552d1        4187
> 28dc8687        4101
> ......
> 5c0c9e31           1
> 5df83b0d           1
> Name: device_id, Length: 2686408, dtype: int64
> ```

该特征值中”a99f214a“计数占据该特征极大比例，考虑该特征值为未采集到数据，为缺失值；



#### device_ip

> ```
> ----------device_ip-----------
> 6b9769f2    208701
> 431b3174    135322
> 2f323f36     88499
> af9205f9     87844
> 930ec31d     86996
> af62faf4     85802
> 009a7861     85382
> ......
> 060dd26f         1
> 9cac90f8         1
> Name: device_ip, Length: 6729486, dtype: int64
> ```

用户设备ip，若原始信息可取，则考虑根据ip分离处地址位置，然后进行聚类，形成新的类别变量，但这里信息不足，只作为一般类别型特征处理。曾考虑利用device_ip，device_id，app_id来定位浏览者，从而统计具体浏览者所浏览的广告数，但



#### device_model

> ```
> ---------device_model---------
> 8a4875bd    2455470
> 1f0bc64f    1424546
> d787e91b    1405169
> 76dc4769     767961
> be6db1d7     742913
> a0f5f879     652751
> ......
> e6df6670          1
> 2dca9f52          1
> Name: device_model, Length: 8251, dtype: int64
> ```

暂不清楚具体含义，作为一般分类型特征处理；



#### device_type

> ```
> ---------device_type----------
> 1    37304667
> 0     2220812
> 4      774272
> 5      129185
> 2          31
> Name: device_type, dtype: int64
> 
> -------------------------device_type-------------------------
>              display_sum  click_rate
> device_type                         
> 0                2220812    0.210731
> 1               37304667    0.169176
> 2                     31    0.064516
> 4                 774272    0.095444
> 5                 129185    0.093842
> ```

device_type中特征值0、1两部分，广告投放量占比较大，同时点击率也较高，说明投放选择的设备类型正确，这应该是不错的特征。



#### device_conn_type

```
-------device_conn_type-------
0    34886838
2     3317443
3     2181796
5       42890
Name: device_conn_type, dtype: int64

-------------------------device_conn_type-------------------------
                  display_sum  click_rate
device_conn_type                         
0                    34886838    0.181125
2                     3317443    0.135289
3                     2181796    0.044043
5                       42890    0.029611
```

可能上网的连接方式，比如移动上网，WIFI等，广告投放量与点击率正比，也是值得关注的特征。



#### C15、C16

```
-------------C15--------------
320     37708959
300      2337294
216       298794
728        74533
120         3069
1024        2560
480         2137
768         1621
Name: C15, dtype: int64

-------------C16--------------
50      38136554
250      1806334
36        298794
480       103365
90         74533
20          3069
768         2560
320         2137
1024        1621
Name: C16, dtype: int64
```

C15、C16结合起来分析，猜测可能为设备的显示尺寸，考虑将这两拼接，新建特征"C15_C16"；

其余特征”C14“，”C17“，”C18“，”C19“，”C20“，”C21“一时难以分辨含义，作为一般分类型特征处理；



## 1.2 特征构建

**标签**：click

**特征**：

* 原始特征：
  * banner_pos,site_id,site_domain,site_category,app_id,app_domain,app_category,device_id,device_ip,device_model,device_type,device_conn_type,C1,C14,C15,C16,C17,C18,C19,C20,C21；
* 新建特征：
  * day：哪一日，由原始特征hour生成；
  * weekday：星期几，由原始特征hour生成；
  * workday：是否工作日，由原始特征hour生成；
  * hour_n：几时，值为0~23的类别值，由原始特征hour生成；
  * C15_C16：广告展示的设备尺寸，由C15、C16生成；

以上一共26维特征，均为分类型；

## 1.3 数据预处理

#### 1.3.1 FFM数据预处理

#### 1.3.2 FCN数据预处理

## 2 模型结构

![structure diagram](C:\Users\ASUS\Desktop\structure diagram.png)

本次作业考虑利用FFM模型和FCN组合来对点击率进行预测，主要分为两个部分：

1. FFM模型：
   1. 将经过处理的数据输入FFM，对其训练，直至模型完成？完成的标准？
   2. 利用完成的模型对数据做特征交叉，生成的特征组合后数据送入全连接层
2. Embedding部分：
   1. 将分类型数据输入嵌入层，利用其对分类型数据展开并降维，然后将所得数据拼接送入FC1
   2. 对FC1进行两次全连接，所得输出与FFM部分经FC的输出拼接，再送入下层全连接层
   3. 对最后的logits施加sigmoid激活，利用FTRL优化算法计算logloss，最终获取模型参数

##3 模型构建

### 3.1 FFM

### 3.2 FCN

### 3.3 模型融合

## 4 模型优化

## 5 结果评价

## 6 体悟



